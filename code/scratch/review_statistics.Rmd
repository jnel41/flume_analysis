---
title: "Flume: Full Analysis (March-November)"
subtitle: "(adapted from Jarad Niemi - Soilpad Analysis)"
author: "Jessica Nelson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      fig.width = 12,
                      fig.height = 12)

library("tidyverse"); theme_set(theme_bw())
library(tidyverse) #for all data wrangling
library(cowplot) #for manuscript ready figures
library(lme4) #for lmer & glmer models
library(sjPlot) #for plotting lmer and glmer mods
library(sjmisc) 
library(effects)
library(sjstats)
install.packages('cowplot')

options(width = 120, scipen = 999)

dir.create("fig", showWarnings = FALSE)
```

```{r}
sessionInfo()
```


```{r load, dependson= "full_dataframe"}
load("E:/ISU/Project/SoilMove/data/statistics/flume_analysis/code/full_df.RData")

rain_event <- read.csv('E:/ISU/Project/SoilMove/data/statistics/flume_analysis/data/tidy/rain_event12.csv', header=TRUE)

rain_event <- rain_event %>% filter(!duplicated(cbind(Year, SiteID, eventStart)))

runoff_event <- read.csv('E:/ISU/Project/SoilMove/data/statistics/flume_analysis/data/tidy/runoff_event12.csv', header=TRUE)

```

## Exploratory analysis

## Site-year with sample event

```{r, dependson="load"}
site_year_rfevent <- full_df %>%
  select(SiteID, Year, sample_event) %>%
  unique()

ggplot(site_year_rfevent, aes(Year, SiteID, fill=sample_event)) +
  geom_tile()
```

```{r mean_data, dependson = "load"}
ppt_sum <- rain_event %>%
  filter(!duplicated(cbind(Year, SiteID, eventStart))) %>%
  group_by(Year, SiteID) %>%
  summarize(sum_pptmm = sum(precipitation, na.rm = TRUE)*1000,
            time_min = sum(rain_time),
            n = n(),
            .groups = "drop")

runoff_sum <- runoff_event %>%
  filter(!duplicated(cbind(Year, SiteID, eventStart))) %>%
  group_by(Year, SiteID, Treatment) %>%
  distinct() %>%
  summarize(sum_flow = sum(flow),
            time_min = sum(flow_time),
            n = n(),
            .groups = "drop")

```

```{r wp_plot, dependson = "plot_data", eval = FALSE, echo = FALSE}
g <- ggplot(full_df, 
           aes(x = log(ppt_sum), y = log(tss_load+0.0016488035), group=Treatment, color=Treatment)) + 
  geom_line() +
  geom_point() +
  facet_grid(SiteID + random ~ Year) + 
  #scale_y_log10() + 
  labs(title ="Total load (log(kg/ha)) by rainfall accumulation per sample event (log(m))") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
g

#ggsave("fig/wp_plot.png", g)
```



```{r wp_per_day_plot, dependson = "plot_data"}
g <- ggplot(load_sum, 
           aes(x = Treatment, 
               y = sum_load)) + 
  geom_point() + 
  geom_line() +
  facet_grid(SiteID ~ Year, scales = "free_y") + 
  #scale_y_log10() + 
  labs(title ="Total load (kg/ha) per field season") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
g

#ggsave("fig/wp_per_day_plot.png", g)
```

Average isn't realistic


```{r strip_boxplot, dependson = "create_soilpad", eval = FALSE, echo = FALSE}
g <- ggplot(flume, 
           aes(x = Year, y = precipitation, color=crop)) + 
  geom_boxplot() +
  geom_point() + 
  #geom_jitter() +
  facet_grid( ~ SiteID) + 
  #scale_y_log10() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
g
```

#```{r, dependson="create_sediment"}
#pivot_sample %>% 
#  anova_test(ln_trt ~ ln_ppt*ln_ctl)
## purr https://stackoverflow.com/questions/50702152/compare-models-via-anova-with-purrr-or-dplyr
## anova() and may need an linear model built up.
#```


# Main Analyses

There are three main analyses of interest:

- confirmatory, design-based analysis
- exploratory, covariate analysis
- relationship of sediment flow to sediment loss

## Confirmatory, design-based analysis

### Treatment effect

```{r design_model, dependson = "load"}
m_flume <- lmerTest::lmer(log(tss_load+0.0016488035) ~ 
                             Treatment*ln_ppt +
                            
                            Year*Treatment +
                            
                            #(1 | SiteID) + #removed due to singular fit
                             (1 | SiteID:Treatment) + 
                            (1|Year:sample_event) + #consider this and below with SiteID 
                            (1|SiteID:Year:sample_event), 
                          
                          data = full_df)

summary(m_flume)

```

```{r design_model_contrasts, dependson = "design_model"}
trt_yr = emmeans(m_flume, pairwise ~ Treatment|Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(trt_yr)$contrasts

trt = emmeans(m_flume, pairwise ~ Treatment, 
                    type = "response", 
                    lmer.df = "asymptotic")
confint(trt)

year = emmeans(m_flume, ~ Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(year)

trt_ppt = emmeans(m_flume, pairwise ~ Treatment|ln_ppt,
                    at=list(ln_ppt=c(-4,-3.5,-3,-2)), 
                    type = "response",
                    lmer.df = "asymptotic")

confint(trt_ppt)$contrasts ## exp. the values

#crop      = emmeans(m_flume, pairwise ~ Treatment|crop,   
#                    type = "response",
#                    lmer.df = "asymptotic")

#confint(crop)$contrasts

```

```{r diversion_figure, dependson="diversion_contrasts"}
trt <- as.data.frame(trt)

k <- trt %>%
  filter(contrast != "strips - control")

trt_plot <- k %>%
  ggplot(aes(x=Treatment, y=response, fill=Treatment))+
  geom_bar(width = 0.5, position = position_dodge(), stat="summary") +
  geom_errorbar(aes(ymin = (response-SE), ymax = (response+SE)),
            width = 0.2,
            linetype = "solid",
            position = position_dodge(width = 0.5),
            color="black", size=0.7) +
  scale_fill_manual(values = c("control" = "#176D9C",
                               "strips" = "#C38820")) +
  ggtitle("Comparison of Total Suspended Sediment (TSS) loads \n (Full Dataset)") +
  xlab("Treatment") +
  ylab("TSS Load \n(kg/ha)") +
  theme(plot.title = element_text(size=20, face="bold", hjust=0.5),
        axis.title.x = element_text(size=18, face="bold"),
        axis.title.y = element_text(size=18, face="bold"),
        axis.text.x = element_text(size=18),
        axis.text.y = element_text(size=18)) +
  scale_x_discrete(labels= c("Control", "Prairie Strip"))

trt_plot
```

# Check assumptions

There are two possible models:

- m_flume: full model design, design-based analysis
- m_flume_model: model design selected based on backward step selection

### Full model design

```{r design_model_residual_plots, dependson = "design_model"}
resid_panel(m_flume, 
            plots = c("resid","index","yvp","qq"),
            smoother = TRUE, qqbands = TRUE)

resid_xpanel(m_flume)
```

```{r caterpillar, eval = FALSE, echo = FALSE}

ggCaterpillar <- function(re, QQ=TRUE, likeDotplot=TRUE, reorder=TRUE) {
  require(ggplot2)
  f <- function(x) {
    pv   <- attr(x, "postVar")
    cols <- 1:(dim(pv)[1])
    se   <- unlist(lapply(cols, function(i) sqrt(pv[i, i, ])))
    if (reorder) {
      ord  <- unlist(lapply(x, order)) + rep((0:(ncol(x) - 1)) * nrow(x), each=nrow(x))
      pDf  <- data.frame(y=unlist(x)[ord],
                         ci=1.96*se[ord],
                         nQQ=rep(qnorm(ppoints(nrow(x))), ncol(x)),
                         ID=factor(rep(rownames(x), ncol(x))[ord], levels=rownames(x)[ord]),
                         ind=gl(ncol(x), nrow(x), labels=names(x)))
    } else {
      pDf  <- data.frame(y=unlist(x),
                         ci=1.96*se,
                         nQQ=rep(qnorm(ppoints(nrow(x))), ncol(x)),
                         ID=factor(rep(rownames(x), ncol(x)), levels=rownames(x)),
                         ind=gl(ncol(x), nrow(x), labels=names(x)))
    }

    if(QQ) {  ## normal QQ-plot
      p <- ggplot(pDf, aes(nQQ, y))
      p <- p + facet_wrap(~ ind, scales="free")
      p <- p + xlab("Standard normal quantiles") + ylab("Random effect quantiles")
    } else {  ## caterpillar dotplot
      p <- ggplot(pDf, aes(ID, y)) + coord_flip()
      if(likeDotplot) {  ## imitate dotplot() -> same scales for random effects
        p <- p + facet_wrap(~ ind)
      } else {           ## different scales for random effects
        p <- p + facet_grid(ind ~ ., scales="free_y")
      }
      p <- p + xlab("Levels") + ylab("Random effects")
    }

    p <- p + theme(legend.position="none")
    p <- p + geom_hline(yintercept=0)
    p <- p + geom_errorbar(aes(ymin=y-ci, ymax=y+ci), width=0, colour="black")
    p <- p + geom_point(aes(size=1.2), colour="blue") 
    return(p)
  }

  lapply(re, f)
}
```

```{r ranef, dependson = "design_model", eval = FALSE, echo = FALSE}
ranef(m_flume)
str(rr1 <- ranef(m_flume))

str(dd <- as.data.frame(rr1))
effects <- dd %>% 
  separate(grp, c('SiteID', 'Year', 'sample_event'))

dotplot(rr1, scales=list(x=list(relation='free')))[['SiteID:Year:sample_event']]
ggCaterpillar(ranef(m_flume,condVar=TRUE), QQ=TRUE, likeDotplot= TRUE, reorder=TRUE)[['SiteID:Year:sample_event']]

qqmath(rr1)

```


```{r ranef_plot, dependson = "ranef", eval = FALSE, echo = FALSE}
g <- ggplot(effects %>% filter(grpvar=='SiteID:Year:sample_event'), 
           aes(x = sample_event, y = condval)) + 
  #geom_line() +
  geom_point() +
  facet_grid(SiteID ~ Year) + 
  #scale_y_log10() + 
  labs(title ="Total load (log(kg/ha)) by sample event") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
g

```
