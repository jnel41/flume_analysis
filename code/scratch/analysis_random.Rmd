---
title: "Flume: Random Analysis (March-November)"
subtitle: "(adapted from Jarad Niemi - Soilpad Analysis)"
author: "Jessica Nelson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      fig.width = 12,
                      fig.height = 12)

library("lme4")
library("lmerTest")
library("tidyverse"); theme_set(theme_bw())
library("emmeans")
library("ggResidpanel")
library("data.table")
library("stringr")

options(width = 120)

dir.create("fig", showWarnings = FALSE)
```

```{r}
sessionInfo()
```

## Read in data

```{r, child="sediment.Rmd"}
```

```{r load, dependson= "full_dataframe"}
load("full_df.RData")
```

```{r flume_random, dependson = "load"}
flumeR <- full_df %>%
  #filter(!is.na(ro_event)) %>%
    subset(random == 'R')

```

## Exploratory analysis

## Site-year with rainfall event

```{r, dependson="flume_random"}
site_year_rfeventR <- flumeR %>%
  select(SiteID, Year, sample_event) %>%
  unique()

ggplot(site_year_rfeventR, aes(Year, SiteID, fill=sample_event)) +
  geom_tile()
```


## Number of samples

Calculate the number of observations for each treatment-position-year-site-time
combination. 

```{r sample_event_counts, dependson="flume_random"}
TSS_countsR <- flumeR %>%
  group_by(Year, SiteID, sample_event) %>%
  distinct() %>%
  summarize(n = n(), .groups = "drop")
```


```{r year_tss_sum, dependson="flume_random"}
TSS_sumR <- flumeR %>%
  group_by(Year, SiteID, Treatment) %>%
  distinct() %>%
  summarize(tss_sum = sum(tss_load), .groups = "drop")
```

Plot the number of observations for each combination. 

```{r plot_count, dependson="sample_event_counts", out.width = "\\textwidth"}
g <- ggplot(TSS_countsR, aes(x = Year, y= SiteID, fill = n)) +
  geom_tile() +
  geom_text(aes(label = n), color = "white") +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g 
##ggsave("fig/soilpad_counts_no_diversion.png", g, width = 12, height = 12)
```

## Data visualization

```{r, dependson="flume_random"}
hR <- ggplot(flumeR, aes(x=ln_ppt, y=log(tss_load+0.0016488035), color=Treatment)) +
  geom_point() + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  ggtitle("Log-log relationship between TSS load and rainfall accumulation \n(random dataset)") +
  theme(plot.title = element_text(size=14, face="bold",hjust = 0.5))
hR  

#ggsave("fig/randReg_ppt_load.png", hR, width = 12, height = 12)
```


# Main Analyses

There are three main analyses of interest:

- confirmatory, design-based analysis
- exploratory, covariate analysis
- relationship of sediment flow to sediment loss


```{r designR_model, dependson = "flume_random"}
mR_flume <- lmerTest::lmer(log(tss_load+0.025) ~ 
                             Treatment*ln_ppt +
                            Year*Treatment +
                            
                            (1 | SiteID) + 
                             #(1 | SiteID:Treatment) + #removed due to singular fit
                            (1|Year:sample_event),# + #removed due to singular fit
                            #(1|SiteID:Year:sample_event), 
                           
                          data = flumeR)


summary(mR_flume)
anova(mR_flume)
performance::r2(mR_flume)
```

```{r designR_step_model, dependson = "designR_model"}
mR_flume_step <- step(mR_flume, reduce.random = FALSE, alpha.fixed = 0.1)
mR_flume_model <- get_model(mR_flume_step)
summary(mR_flume_model)

##https://campus.datacamp.com/courses/hierarchical-and-mixed-effects-models-in-r/linear-mixed-effect-models?ex=7
```


```{r designR_model_contrasts, dependson = "designR_model"}
trt_yrR = emmeans(mR_flume, pairwise ~ Treatment|Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(trt_yrR)$contrasts

trtR    = emmeans(mR_flume, pairwise ~ Treatment, 
                    type = "response", 
                    lmer.df = "asymptotic")
confint(trtR)

yearR   = emmeans(mR_flume, ~ Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(yearR)

trt_pptR  = emmeans(mR_flume, pairwise ~ Treatment|ln_ppt,
                    at=list(ln_ppt=c(-4,-3,-2,-1,-0.25)), 
                    type = "response",
                    lmer.df = "asymptotic")

confint(trt_pptR)$contrasts ## exp. the values

#cropR      = emmeans(mR_flume, pairwise ~ Treatment|crop,   
#                    type = "response",
#                    lmer.df = "asymptotic")

#confint(cropR)
```
# Check assumptions

There are two possible models:

- mR_flume: full model design, design-based analysis
- mR_flume_model: model design selected based on backward step selection

### Full model design

```{r designR_model_residual_plots, dependson = "designR_model"}
resid_panel(mR_flume, 
            plots = c("resid","index","yvp","qq"),
            smoother = TRUE, qqbands = TRUE)

resid_xpanel(mR_flume)
```

```{r designR_step_residual_plots, dependson = "designR_model"}
resid_panel(mR_flume_model, 
            plots = c("resid","index","yvp","qq"),
            smoother = TRUE, qqbands = TRUE)

resid_xpanel(mR_flume_model)
```

```{r designR_model_figure, dependson="design_model_contrasts"}
trtR <- as.data.frame(trtR)

jR <- trtR %>%
  filter(Treatment != ".")

trtR_plot <- jR %>%
  ggplot(aes(x=Treatment, y=response, fill=Treatment))+
  geom_bar(width = 0.5, position = position_dodge(), stat="summary") +
  geom_errorbar(aes(ymin = (response-SE), ymax = (response+SE)),
            width = 0.2,
            linetype = "solid",
            position = position_dodge(width = 0.5),
            color="black", size=0.7) +
  scale_fill_manual(values=c('#C38820','#176D9C')) +
  ggtitle("Comparison of mean TSS load measured by flume \n across sampling events (2016-2020)") +
  xlab("Treatment") + 
  ylab("TSS Load (kg/ha)") +
  theme(plot.title = element_text(size=16, face="bold", hjust=0.5),
        axis.title.x = element_text(size=14, face="bold"),
        axis.title.y = element_text(size=14, face="bold"),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12)) +
  scale_x_discrete(labels= c("Control", "Prairie Strips"))
  #geom_text(aes(label=round(Score,2)), position=position_dodge(width=0.5),  vjust=-0.25) + 
  #geom_text(aes(y = lb, label = lb), position=position_dodge(width=0.5), vjust=2)

trtR_plot

```