---
title: "Flume: Full Analysis"
author: "Jessica Nelson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE,
                      fig.width = 12,
                      fig.height = 12)

library("lme4")
library("lmerTest")
library("tidyverse"); theme_set(theme_bw())

library("emmeans")
library("ggResidpanel")
library("data.table")
library("stringr")


options(width = 120)

dir.create("fig", showWarnings = FALSE)
```

```{r}
sessionInfo()
```

## Read in data

```{r, child="sediment.Rmd"}
```


```{r load, dependson= "full_dataframe"}
load("full_df.RData")
```

## Exploratory analysis

## Site-year with rainfall event

```{r, dependson="load"}
site_year_rfevent <- full_df %>%
  select(SiteID, Year, sample_event) %>%
  unique()

ggplot(site_year_rfevent, aes(Year, SiteID, fill=sample_event)) +
  geom_tile()
```


## Number of samples

Calculate the number of observations for each treatment-position-year-site-time
combination. 

```{r sample_event_counts, dependson="create_sediment"}
TSS_counts <- flume %>%
  group_by(Year, SiteID, rf_event) %>%
  distinct() %>%
  summarize(n = n(), .groups = "drop")
```

Plot the number of observations for each combination. 

```{r plot_count, dependson="sample_event_counts", out.width = "\\textwidth"}
g <- ggplot(TSS_counts, aes(x = Year, y= SiteID, fill = n)) +
  geom_tile() +
  geom_text(aes(label = n), color = "white") +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g 
```


## Data visualization

```{r, dependson="load"}
h <- ggplot(full_df, aes(x=ln_ppt, y=ln_tss_load, color=Treatment), inherit.aes = FALSE) +
  geom_point() + 
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  ggtitle("Log-log relationship between TSS load and rainfall accumulation \n(full dataset)") +
  theme(plot.title = element_text(size=14, face="bold",hjust = 0.5))
  
h
#ggsave("fig/randReg_ppt_load.png", h, width = 12, height = 12)

```


#```{r, dependson="create_sediment"}
#pivot_sample %>% 
#  anova_test(ln_trt ~ ln_ppt*ln_ctl)
## purr https://stackoverflow.com/questions/50702152/compare-models-via-anova-with-purrr-or-dplyr
## anova() and may need an linear model built up.
#```


# Main Analyses

There are three main analyses of interest:

- confirmatory, design-based analysis
- exploratory, covariate analysis
- relationship of sediment flow to sediment loss

## Confirmatory, design-based analysis

### Treatment effect

```{r design_model, dependson = "load"}
m_flume <- lmerTest::lmer(log(tss_load+0.005322915) ~ 
                             (1 | SiteID) +
                             (1 | SiteID:Treatment) + 
                            #(1|SiteID:Treatment:sample_event) + removed due to singular fit
                            
                             Treatment*ln_ppt + 
                            Treatment*crop +
                            
                            Year,
                          data = full_df)

summary(m_flume)

```

```{r design_step_model, dependson = "design_model"}
m_flume_step <- step(m_flume, reduce.random = FALSE, alpha.fixed = 0.1)
m_flume_model <- get_model(m_flume_step)
summary(m_flume_model)

##https://campus.datacamp.com/courses/hierarchical-and-mixed-effects-models-in-r/linear-mixed-effect-models?ex=7
```



```{r design_model_contrasts, dependson = "design_model"}
trt_yr = emmeans(m_flume, pairwise ~ Treatment|Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(trt_yr)$contrasts

trt = emmeans(m_flume, pairwise ~ Treatment, 
                    type = "response", 
                    lmer.df = "asymptotic")
confint(trt)

year = emmeans(m_flume, ~ Year, 
                    type = "response",
                    lmer.df = "asymptotic") 
confint(year)

trt_ppt = emmeans(m_flume, pairwise ~ Treatment|ln_ppt,
                    at=list(ln_ppt=c(-4,-3,-2)), 
                    type = "response",
                    lmer.df = "asymptotic")

confint(trt_ppt)$contrasts ## exp. the values

crop      = emmeans(m_flume, pairwise ~ Treatment|crop,   
                    type = "response",
                    lmer.df = "asymptotic")

confint(crop)$contrasts

```
# Check assumptions

There are two possible models:

- m_flume: full model design, design-based analysis
- m_flume_model: model design selected based on backward step selection

### Full model design

```{r design_model_residual_plots, dependson = "design_model"}
resid_panel(m_flume, 
            plots = c("resid","index","yvp","qq"),
            smoother = TRUE, qqbands = TRUE)

resid_xpanel(m_flume)
```

### Selected model design
```{r design_step_residual_plots, dependson = "design_step_model"}
resid_panel(m_flume_model, 
            plots = c("resid","index","yvp","qq"),
            smoother = TRUE, qqbands = TRUE)

resid_xpanel(m_flume_model)
```